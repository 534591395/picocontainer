{"version":3,"file":"index.esm.js","sources":["../src/utils.ts","../src/scoped_css.ts","../src/source.ts","../src/app.ts","../src/constants.ts","../src/app_element.ts","../src/index.ts"],"sourcesContent":["/**\n * 获取静态资源\n * @param {string} url 静态资源地址\n */\n export function fetchSource (url: string) {\n  return fetch(url).then((res) => {\n    return res.text()\n  })\n}\n","// 子应用的样式作用域处理\n\nlet templateStyle: any = null // 模版sytle\n\nexport default function scopedCSS(styleElement: HTMLStyleElement, appName: string) {\n  const prefix = `picocontainer-app[name=${appName}]`\n\n  if (!templateStyle) {\n    templateStyle = document.createElement('style')\n    document.body.appendChild(templateStyle)\n    // 设置样式表无效，防止对应用造成影响\n    templateStyle.sheet.disabled = true\n  }\n\n  if (styleElement.textContent) {\n    templateStyle.textContent = styleElement.textContent\n    styleElement.textContent = scopedRule(Array.from(templateStyle.sheet?.cssRules ?? []), prefix)\n    templateStyle.textContent = ''\n  } else {\n    // 监听动态添加内容的style元素\n    const observer = new MutationObserver(() => {\n      observer.disconnect()\n      styleElement.textContent = scopedRule(Array.from(styleElement.sheet?.cssRules ?? []), prefix)\n    })\n\n    // 监听style元素的内容是否变化\n    observer.observe(styleElement, { childList: true })\n  }\n}\n\n\n// 依次处理每个cssRule\nfunction scopedRule(rules: CSSRule[], prefix: string) {\n  let result = ''\n  // 遍历rules, 处理每一条规则\n  // https://www.w3.org/html/ig/zh/wiki/Cssom#CSS.E8.A7.84.E5.88.99\n  // 由于 CSSRule.type 被废弃，改用 rule.constructor.name 判断规则类型。https://wiki.csswg.org/spec/cssom-constants\n  for (const rule of rules) {\n    if (rule.constructor.name === 'CSSStyleRule') {\n      result += scopedStyleRule(rule as CSSStyleRule, prefix)\n    } else\n    if (rule.constructor.name === 'CSSMediaRule') {\n      result += scopedPackRule(rule as CSSMediaRule, prefix, 'media')\n    } else\n    if (rule.constructor.name === 'CSSSupportsRule') {\n      result += scopedPackRule(rule as CSSSupportsRule, prefix, 'supports')\n    } else {\n      result += rule.cssText\n    }\n  }\n\n  return result\n}\n\n\n// 处理media 和 supports\nfunction scopedPackRule (rule: CSSMediaRule | CSSSupportsRule, prefix: string, packName: string) {\n  // 递归执行scopedRule，处理media 和 supports内部规则\n  const result = scopedRule(Array.from(rule.cssRules), prefix)\n  return `@${packName} ${rule.conditionText} {${result}}`\n}\n\n\nfunction scopedStyleRule (rule: CSSStyleRule, prefix: string) {\n  // 获取CSS规则对象的选择和内容\n  const { selectorText, cssText } = rule\n\n  // 处理顶层选择器，如 body，html 都转换为 picocontainer-app[name=xxx]\n  if (/^((html[\\s>~,]+body)|(html|body|:root))$/.test(selectorText)) {\n    return cssText.replace(/^((html[\\s>~,]+body)|(html|body|:root))/, prefix)\n  } else if (selectorText === '*') {\n    // 选择器 * 替换为 picocontainer-app[name=xxx] *\n    return cssText.replace('*', `${prefix} *`)\n  }\n\n  const builtInRootSelectorRE = /(^|\\s+)((html[\\s>~]+body)|(html|body|:root))(?=[\\s>~]+|$)/\n\n  // 匹配查询选择器\n  return cssText.replace(/^[\\s\\S]+{/, (selectors) => {\n    return selectors.replace(/(^|,)([^,]+)/g, (all, $1, $2) => {\n      // 如果含有顶层选择器，需要单独处理\n      if (builtInRootSelectorRE.test($2)) {\n        // body[name=xx]|body.xx|body#xx 等都不需要转换\n        return all.replace(builtInRootSelectorRE, prefix)\n      }\n      // 在选择器前加上前缀\n      return `${$1} ${prefix} ${$2.replace(/^\\s*/, '')}`\n    })\n  })\n}\n","\nimport { fetchSource } from './utils'\nimport scopedCSS from './scoped_css'\n\nexport default function loadHtml (app: any) {\n  fetchSource(app.url).then((html) => {\n    html = html\n      .replace(/<head[^>]*>[\\s\\S]*?<\\/head>/i, (match) => {\n        // 将head标签替换为picocontainer-app-head，因为web页面只允许有一个head标签\n        return match\n          .replace(/<head/i, '<picocontainer-app-head')\n          .replace(/<\\/head>/i, '</picocontainer-app-head>')\n      })\n      .replace(/<body[^>]*>[\\s\\S]*?<\\/body>/i, (match) => {\n        // 将body标签替换为picocontainer-app-body，防止与基座应用的body标签重复导致的问题。\n        return match\n          .replace(/<body/i, '<picocontainer-app-body')\n          .replace(/<\\/body>/i, '</picocontainer-app-body>')\n      })\n\n    // 将html字符串转化为DOM结构\n    const htmlDom = document.createElement('div')\n    htmlDom.innerHTML = html\n    console.log('html:', htmlDom)\n\n    // 进一步提取和处理js、css等静态资源\n    extractSourceDom(htmlDom, app)\n\n    // picocontainer-app-head元素\n    const picocontainerAppHead = htmlDom.querySelector('picocontainer-app-head')\n    // 如果有远程css资源，则通过fetch请求\n    if (app.source.links.size) {\n      fetchLinksFromHtml(app, picocontainerAppHead, htmlDom)\n    } else {\n      app.onLoad(htmlDom)\n    }\n\n    // 如果有远程js资源，则通过fetch请求\n    if (app.source.scripts.size) {\n      fetchScriptsFromHtml(app, htmlDom)\n    } else {\n      app.onLoad(htmlDom)\n    }\n\n  }).catch((e) => {\n    console.error('加载html出错', e)\n  })\n}\n\n/**\n * 递归处理每一个子元素\n * @param parent 父元素\n * @param app 应用实例\n */\n function extractSourceDom(parent: any, app: any) {\n  const children = Array.from(parent.children)\n\n  // 递归每一个子元素\n  children.length && children.forEach((child) => {\n    extractSourceDom(child, app)\n  })\n\n  for (const dom of children) {\n    if (dom instanceof HTMLLinkElement) {\n      // 提取css地址\n      const href = dom.getAttribute('href')\n      if (dom.getAttribute('rel') === 'stylesheet' && href) {\n        // 计入source缓存中\n        app.source.links.set(href, {\n          code: '', // 代码内容\n        })\n      }\n      // 删除原有元素\n      parent.removeChild(dom)\n    } else if (dom instanceof HTMLScriptElement) {\n      // 并提取js地址\n      const src = dom.getAttribute('src')\n      if (src) { // 远程script\n        app.source.scripts.set(src, {\n          code: '', // 代码内容\n          isExternal: true, // 是否远程script\n        })\n      } else if (dom.textContent) { // 内联script\n        const nonceStr = Math.random().toString(36).substr(2, 15)\n        app.source.scripts.set(nonceStr, {\n          code: dom.textContent, // 代码内容\n          isExternal: false, // 是否远程script\n        })\n      }\n\n      parent.removeChild(dom)\n    } else if (dom instanceof HTMLStyleElement) {\n      // 进行样式隔离\n      scopedCSS(dom, app.name)\n    }\n  }\n}\n\n\n/**\n * 获取link远程资源\n * @param app 应用实例\n * @param microAppHead micro-app-head\n * @param htmlDom html DOM结构\n */\n export function fetchLinksFromHtml (app: any, microAppHead: any, htmlDom: any) {\n  const linkEntries: any = Array.from(app.source.links.entries())\n  // 通过fetch请求所有css资源\n  const fetchLinkPromise = []\n  for (const [url] of linkEntries) {\n    fetchLinkPromise.push(fetchSource(app.url+url))\n  }\n\n  Promise.all(fetchLinkPromise).then((res) => {\n    for (let i = 0; i < res.length; i++) {\n      const code = res[i]\n      // 拿到css资源后放入style元素并插入到micro-app-head中\n      const link2Style = document.createElement('style')\n      link2Style.textContent = code\n      // 样式隔离\n      scopedCSS(link2Style, app.name)\n      microAppHead.appendChild(link2Style)\n\n      // 将代码放入缓存，再次渲染时可以从缓存中获取\n      linkEntries[i][1].code = code\n    }\n\n    // 处理完成后执行onLoad方法\n    app.onLoad(htmlDom)\n  }).catch((e) => {\n    console.error('加载css出错', e)\n  })\n}\n\n/**\n * 获取js远程资源\n * @param app 应用实例\n * @param htmlDom html DOM结构\n */\n export function fetchScriptsFromHtml (app: any, htmlDom: any) {\n  const scriptEntries: any = Array.from(app.source.scripts.entries())\n  // 通过fetch请求所有js资源\n  const fetchScriptPromise = []\n  for (const [url, info] of scriptEntries) {\n    // 如果是内联script，则不需要请求资源\n    fetchScriptPromise.push(info.code ? Promise.resolve(info.code) :  fetchSource(app.url+url))\n  }\n\n  Promise.all(fetchScriptPromise).then((res) => {\n    for (let i = 0; i < res.length; i++) {\n      const code = res[i]\n      // 将代码放入缓存，再次渲染时可以从缓存中获取\n      scriptEntries[i][1].code = code\n    }\n\n    // 处理完成后执行onLoad方法\n    app.onLoad(htmlDom)\n  }).catch((e) => {\n    console.error('加载js出错', e)\n  })\n}\n","// 应用  ，SSR\nimport loadHtml from './source'\n\nexport interface CreateAppParam {\n  name: string\n  url: string\n  scopecss?: boolean\n  useSandbox?: boolean\n  macro?: boolean\n  inline?: boolean\n  baseroute?: string\n  container?: HTMLElement | ShadowRoot\n}\n\nexport default class PicocontainerApp {\n  name: string = ''\n  url: string = ''\n  container: HTMLElement | ShadowRoot | null = null\n  loadCount = 0\n\n  constructor({ name, url, container}: CreateAppParam) {\n    this.container = container ?? null\n    this.name = name\n    this.url = url\n    this.status = 'loading'\n    loadHtml(this)\n  }\n\n  status = 'created' // 组件状态，包括 created/loading/mount/unmount\n\n  // 存放应用的静态资源\n  source: any = {\n    links: new Map(), // link元素对应的静态资源\n    scripts: new Map(), // script元素对应的静态资源\n    html: ''\n  }\n\n  // 资源加载完时执行\n  onLoad (htmlDom: any) {\n    this.loadCount = this.loadCount ? this.loadCount + 1 : 1\n    // 第二次执行且组件未卸载时执行渲染\n    if (this.loadCount === 2 && this.status !== 'unmount') {\n      // 记录DOM结构用于后续操作\n      this.source.html = htmlDom\n      // 执行mount方法\n      this.mount()\n    }\n  }\n\n  /**\n   * 资源加载完成后进行渲染\n   */\n  mount () {\n    // 克隆DOM节点\n    const cloneHtml = this.source.html.cloneNode(true)\n    // 创建一个fragment节点作为模版，这样不会产生冗余的元素\n    const fragment = document.createDocumentFragment()\n    Array.from(cloneHtml.childNodes).forEach((node: any) => {\n      fragment.appendChild(node)\n    })\n\n    // 将格式化后的DOM结构插入到容器中\n    this.container?.appendChild(fragment)\n\n    // 执行js\n    this.source.scripts.forEach((info: any) => {\n      (0, eval)(info.code)\n    })\n\n    // 标记应用为已渲染\n    this.status = 'mounted'\n  }\n\n  /**\n   * 卸载应用\n   * 执行关闭沙箱，清空缓存等操作\n   */\n  unmount () {}\n}\n\n// 资源缓存\nexport const appInstanceMap = new Map()\n","export enum ObservedAttrName {\n  NAME = 'name',\n  URL = 'url',\n}\n","\nimport CreateApp, { appInstanceMap } from './app'\n\nimport { ObservedAttrName } from './constants'\n\n// 自定义元素\nclass MyElement extends HTMLElement {\n  // 声明需要监听的属性名，只有这些属性变化时才会触发attributeChangedCallback\n  static get observedAttributes() {\n    return ['name', 'url']\n  }\n\n  appName = ''\n  appUrl = ''\n\n  constructor() {\n    super()\n  }\n\n  connectedCallback() {\n    // 元素被插入到DOM时执行，此时去加载子应用的静态资源并渲染\n    console.log('picocontainer-app is connected')\n    // 创建微应用实例\n    const app = new CreateApp({\n      name: this.appName!,\n      url: this.appUrl!,\n      container: this,\n    })\n\n    // 记入缓存，用于后续功能\n    appInstanceMap.set(this.appName, app)\n  }\n\n  disconnectedCallback () {\n    // 元素从DOM中删除时执行，此时进行一些卸载操作\n    console.log('picocontainer-app has disconnected')\n\n    // 获取应用实例\n    const app = appInstanceMap.get(this.appName)\n    // 如果有属性destory，则完全卸载应用包括缓存的文件\n    app.unmount(this.hasAttribute('destory'))\n  }\n\n  attributeChangedCallback (attr: ObservedAttrName, _oldVal: string, newVal: string): void {\n    // 元素属性发生变化时执行，可以获取name、url等属性的值\n    console.log(`attribute ${attr}: ${newVal}-${_oldVal}`)\n\n    if (this[attr === ObservedAttrName.NAME ? 'appName' : 'appUrl'] !== newVal) {\n      if (attr === ObservedAttrName.URL && !this.appUrl) {\n        this.appUrl = newVal\n      } else if (attr === ObservedAttrName.NAME && !this.appName) {\n        this.appName = newVal\n      }\n    }\n  }\n\n}\n\nexport function defineElement () {\n  // 如果已经定义过，则忽略\n  if (!window.customElements.get('picocontainer-app')) {\n    /**\n     * 注册元素\n     * 注册后，就可以像普通元素一样使用picocontainer-app，当picocontainer-app元素被插入或删除DOM时即可触发相应的生命周期函数。\n     */\n    window.customElements.define(`picocontainer-app`, MyElement)\n  }\n}\n","// 参考：https://zhuanlan.zhihu.com/p/395752022\n// 入口文件\n\nimport { defineElement } from './app_element'\n\nconst SimplePicocontainerApp = {\n  start() {\n    defineElement()\n  }\n}\n\nexport default SimplePicocontainerApp\n"],"names":["CreateApp"],"mappings":"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"}