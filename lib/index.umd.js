!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).picocontaineroApp={})}(this,(function(e){"use strict";function t(e){return fetch(e).then((e=>e.text()))}let n=null;function o(e,t){var o,i;const r=`picocontainer-app[name=${t}]`;if(n||(n=document.createElement("style"),document.body.appendChild(n),n.sheet.disabled=!0),e.textContent)n.textContent=e.textContent,e.textContent=s(Array.from(null!==(i=null===(o=n.sheet)||void 0===o?void 0:o.cssRules)&&void 0!==i?i:[]),r),n.textContent="";else{const t=new MutationObserver((()=>{var n,o;t.disconnect(),e.textContent=s(Array.from(null!==(o=null===(n=e.sheet)||void 0===n?void 0:n.cssRules)&&void 0!==o?o:[]),r)}));t.observe(e,{childList:!0})}}function s(e,t){let n="";for(const o of e)"CSSStyleRule"===o.constructor.name?n+=r(o,t):"CSSMediaRule"===o.constructor.name?n+=i(o,t,"media"):"CSSSupportsRule"===o.constructor.name?n+=i(o,t,"supports"):n+=o.cssText;return n}function i(e,t,n){const o=s(Array.from(e.cssRules),t);return`@${n} ${e.conditionText} {${o}}`}function r(e,t){const{selectorText:n,cssText:o}=e;if(/^((html[\s>~,]+body)|(html|body|:root))$/.test(n))return o.replace(/^((html[\s>~,]+body)|(html|body|:root))/,t);if("*"===n)return o.replace("*",`${t} *`);const s=/(^|\s+)((html[\s>~]+body)|(html|body|:root))(?=[\s>~]+|$)/;return o.replace(/^[\s\S]+{/,(e=>e.replace(/(^|,)([^,]+)/g,((e,n,o)=>s.test(o)?e.replace(s,t):`${n} ${t} ${o.replace(/^\s*/,"")}`))))}function c(e){t(e.url).then((n=>{n=n.replace(/<head[^>]*>[\s\S]*?<\/head>/i,(e=>e.replace(/<head/i,"<picocontainer-app-head").replace(/<\/head>/i,"</picocontainer-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(e=>e.replace(/<body/i,"<picocontainer-app-body").replace(/<\/body>/i,"</picocontainer-app-body>")));const s=document.createElement("div");s.innerHTML=n,console.log("html:",s),a(s,e);const i=s.querySelector("picocontainer-app-head");e.source.links.size?function(e,n,s){const i=Array.from(e.source.links.entries()),r=[];for(const[n]of i)r.push(t(e.url+n));Promise.all(r).then((t=>{for(let s=0;s<t.length;s++){const r=t[s],c=document.createElement("style");c.textContent=r,o(c,e.name),n.appendChild(c),i[s][1].code=r}e.onLoad(s)})).catch((e=>{console.error("加载css出错",e)}))}(e,i,s):e.onLoad(s),e.source.scripts.size?function(e,n){const o=Array.from(e.source.scripts.entries()),s=[];for(const[n,i]of o)s.push(i.code?Promise.resolve(i.code):t(e.url+n));Promise.all(s).then((t=>{for(let e=0;e<t.length;e++){const n=t[e];o[e][1].code=n}e.onLoad(n)})).catch((e=>{console.error("加载js出错",e)}))}(e,s):e.onLoad(s)})).catch((e=>{console.error("加载html出错",e)}))}function a(e,t){const n=Array.from(e.children);n.length&&n.forEach((e=>{a(e,t)}));for(const s of n)if(s instanceof HTMLLinkElement){const n=s.getAttribute("href");"stylesheet"===s.getAttribute("rel")&&n&&t.source.links.set(n,{code:""}),e.removeChild(s)}else if(s instanceof HTMLScriptElement){const n=s.getAttribute("src");if(n)t.source.scripts.set(n,{code:"",isExternal:!0});else if(s.textContent){const e=Math.random().toString(36).substr(2,15);t.source.scripts.set(e,{code:s.textContent,isExternal:!1})}e.removeChild(s)}else s instanceof HTMLStyleElement&&o(s,t.name)}const l=window.addEventListener,d=window.removeEventListener;class u{constructor(){this.active=!1,this.picocontainerWindow={},this.injectedKeys=new Set,this.releaseEffect=null,this.proxyWindow=null,this.releaseEffect=function(e){const t=new Map;return e.addEventListener=function(e,n,o){const s=t.get(e);return s?s.add(n):t.set(e,new Set([n])),l.call(window,e,n,o)},e.removeEventListener=function(e,n,o){const s=t.get(e);return(null==s?void 0:s.size)&&s.has(n)&&s.delete(n),d.call(window,e,n,o)},()=>{t.size&&(t.forEach(((e,t)=>{if(e.size)for(const n of e)d.call(window,t,n)})),t.clear())}}(this.picocontainerWindow),this.proxyWindow=new Proxy(this.picocontainerWindow,{get:(e,t)=>{if(Reflect.has(e,t))return Reflect.get(e,t);const n=Reflect.get(window,t);if("function"==typeof n){const e=n.toString();if(!/^function\s+[A-Z]/.test(e)&&!/^class\s+/.test(e))return n.bind(window)}return n},set:(e,t,n)=>(this.active&&(Reflect.set(e,t,n),this.injectedKeys.add(t)),!0),deleteProperty:(e,t)=>!e.hasOwnProperty(t)||Reflect.deleteProperty(e,t)})}start(){this.active||(this.active=!0)}stop(){this.active&&(this.active=!1),this.injectedKeys.forEach((e=>{Reflect.deleteProperty(this.picocontainerWindow,e)})),this.injectedKeys.clear(),this.releaseEffect()}bindScope(e){return window.proxyWindow=this.proxyWindow,`;(function(window, self) {\n      with(window) {\n        ;${e}\n\n      }\n    }).call(window.proxyWindow, window.proxyWindow, window.proxyWindow);`}}const h=new Map;class p{constructor({name:e,url:t,container:n}){this.name="",this.url="",this.container=null,this.loadCount=0,this.sandbox=null,this.status="created",this.source={links:new Map,scripts:new Map,html:""},this.container=null!=n?n:null,this.name=e,this.url=t,this.status="loading",c(this),this.sandbox=new u}onLoad(e){this.loadCount=this.loadCount?this.loadCount+1:1,2===this.loadCount&&"unmount"!==this.status&&(this.source.html=e,this.mount())}mount(){var e;const t=this.source.html.cloneNode(!0),n=document.createDocumentFragment();Array.from(t.childNodes).forEach((e=>{n.appendChild(e)})),null===(e=this.container)||void 0===e||e.appendChild(n),this.source.scripts.forEach((e=>{(0,eval)(this.sandbox.bindScope(e.code))})),this.status="mounted"}unmount(e){var t;this.status="unmount",this.container=null,null===(t=this.sandbox)||void 0===t||t.stop(),e&&h.delete(this.name)}}var f;!function(e){e.NAME="name",e.URL="url"}(f||(f={}));class m extends HTMLElement{constructor(){super(),this.appName="",this.appUrl=""}static get observedAttributes(){return["name","url"]}connectedCallback(){console.log("picocontainer-app is connected");const e=new p({name:this.appName,url:this.appUrl,container:this});h.set(this.appName,e)}disconnectedCallback(){console.log("picocontainer-app has disconnected");h.get(this.appName).unmount(this.hasAttribute("destory"))}attributeChangedCallback(e,t,n){console.log(`attribute ${e}: ${n}-${t}`),this[e===f.NAME?"appName":"appUrl"]!==n&&(e!==f.URL||this.appUrl?e!==f.NAME||this.appName||(this.appName=n):this.appUrl=n)}}const w={start(){window.customElements.get("picocontainer-app")||window.customElements.define("picocontainer-app",m)}};e.default=w,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
