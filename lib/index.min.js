"use strict";function t(t){return fetch(t).then((t=>t.text()))}Object.defineProperty(exports,"__esModule",{value:!0});let e=null;function n(t,n){var s,i;const r=`picocontainer-app[name=${n}]`;if(e||(e=document.createElement("style"),document.body.appendChild(e),e.sheet.disabled=!0),t.textContent)e.textContent=t.textContent,t.textContent=o(Array.from(null!==(i=null===(s=e.sheet)||void 0===s?void 0:s.cssRules)&&void 0!==i?i:[]),r),e.textContent="";else{const e=new MutationObserver((()=>{var n,s;e.disconnect(),t.textContent=o(Array.from(null!==(s=null===(n=t.sheet)||void 0===n?void 0:n.cssRules)&&void 0!==s?s:[]),r)}));e.observe(t,{childList:!0})}}function o(t,e){let n="";for(const o of t)"CSSStyleRule"===o.constructor.name?n+=i(o,e):"CSSMediaRule"===o.constructor.name?n+=s(o,e,"media"):"CSSSupportsRule"===o.constructor.name?n+=s(o,e,"supports"):n+=o.cssText;return n}function s(t,e,n){const s=o(Array.from(t.cssRules),e);return`@${n} ${t.conditionText} {${s}}`}function i(t,e){const{selectorText:n,cssText:o}=t;if(/^((html[\s>~,]+body)|(html|body|:root))$/.test(n))return o.replace(/^((html[\s>~,]+body)|(html|body|:root))/,e);if("*"===n)return o.replace("*",`${e} *`);const s=/(^|\s+)((html[\s>~]+body)|(html|body|:root))(?=[\s>~]+|$)/;return o.replace(/^[\s\S]+{/,(t=>t.replace(/(^|,)([^,]+)/g,((t,n,o)=>s.test(o)?t.replace(s,e):`${n} ${e} ${o.replace(/^\s*/,"")}`))))}function r(e){t(e.url).then((o=>{o=o.replace(/<head[^>]*>[\s\S]*?<\/head>/i,(t=>t.replace(/<head/i,"<picocontainer-app-head").replace(/<\/head>/i,"</picocontainer-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(t=>t.replace(/<body/i,"<picocontainer-app-body").replace(/<\/body>/i,"</picocontainer-app-body>")));const s=document.createElement("div");s.innerHTML=o,console.log("html:",s),c(s,e);const i=s.querySelector("picocontainer-app-head");e.source.links.size?function(e,o,s){const i=Array.from(e.source.links.entries()),r=[];for(const[n]of i)r.push(t(e.url+n));Promise.all(r).then((t=>{for(let s=0;s<t.length;s++){const r=t[s],c=document.createElement("style");c.textContent=r,n(c,e.name),o.appendChild(c),i[s][1].code=r}e.onLoad(s)})).catch((t=>{console.error("加载css出错",t)}))}(e,i,s):e.onLoad(s),e.source.scripts.size?function(e,n){const o=Array.from(e.source.scripts.entries()),s=[];for(const[n,i]of o)s.push(i.code?Promise.resolve(i.code):t(e.url+n));Promise.all(s).then((t=>{for(let e=0;e<t.length;e++){const n=t[e];o[e][1].code=n}e.onLoad(n)})).catch((t=>{console.error("加载js出错",t)}))}(e,s):e.onLoad(s)})).catch((t=>{console.error("加载html出错",t)}))}function c(t,e){const o=Array.from(t.children);o.length&&o.forEach((t=>{c(t,e)}));for(const s of o)if(s instanceof HTMLLinkElement){const n=s.getAttribute("href");"stylesheet"===s.getAttribute("rel")&&n&&e.source.links.set(n,{code:""}),t.removeChild(s)}else if(s instanceof HTMLScriptElement){const n=s.getAttribute("src");if(n)e.source.scripts.set(n,{code:"",isExternal:!0});else if(s.textContent){const t=Math.random().toString(36).substr(2,15);e.source.scripts.set(t,{code:s.textContent,isExternal:!1})}t.removeChild(s)}else s instanceof HTMLStyleElement&&n(s,e.name)}const a=window.addEventListener,l=window.removeEventListener;class d{constructor(){this.active=!1,this.picocontainerWindow={},this.injectedKeys=new Set,this.releaseEffect=null,this.proxyWindow=null,this.releaseEffect=function(t){const e=new Map;return t.addEventListener=function(t,n,o){const s=e.get(t);return s?s.add(n):e.set(t,new Set([n])),a.call(window,t,n,o)},t.removeEventListener=function(t,n,o){const s=e.get(t);return(null==s?void 0:s.size)&&s.has(n)&&s.delete(n),l.call(window,t,n,o)},()=>{e.size&&(e.forEach(((t,e)=>{if(t.size)for(const n of t)l.call(window,e,n)})),e.clear())}}(this.picocontainerWindow),this.proxyWindow=new Proxy(this.picocontainerWindow,{get:(t,e)=>{if(Reflect.has(t,e))return Reflect.get(t,e);const n=Reflect.get(window,e);if("function"==typeof n){const t=n.toString();if(!/^function\s+[A-Z]/.test(t)&&!/^class\s+/.test(t))return n.bind(window)}return n},set:(t,e,n)=>(this.active&&(Reflect.set(t,e,n),this.injectedKeys.add(e)),!0),deleteProperty:(t,e)=>!t.hasOwnProperty(e)||Reflect.deleteProperty(t,e)})}start(){this.active||(this.active=!0)}stop(){this.active&&(this.active=!1),this.injectedKeys.forEach((t=>{Reflect.deleteProperty(this.picocontainerWindow,t)})),this.injectedKeys.clear(),this.releaseEffect()}bindScope(t){return window.proxyWindow=this.proxyWindow,`;(function(window, self) {\n      with(window) {\n        ;${t}\n\n      }\n    }).call(window.proxyWindow, window.proxyWindow, window.proxyWindow);`}}const u=new Map;class h{constructor({name:t,url:e,container:n}){this.name="",this.url="",this.container=null,this.loadCount=0,this.sandbox=null,this.status="created",this.source={links:new Map,scripts:new Map,html:""},this.container=null!=n?n:null,this.name=t,this.url=e,this.status="loading",r(this),this.sandbox=new d}onLoad(t){this.loadCount=this.loadCount?this.loadCount+1:1,2===this.loadCount&&"unmount"!==this.status&&(this.source.html=t,this.mount())}mount(){var t;const e=this.source.html.cloneNode(!0),n=document.createDocumentFragment();Array.from(e.childNodes).forEach((t=>{n.appendChild(t)})),null===(t=this.container)||void 0===t||t.appendChild(n),this.source.scripts.forEach((t=>{(0,eval)(this.sandbox.bindScope(t.code))})),this.status="mounted"}unmount(t){var e;this.status="unmount",this.container=null,null===(e=this.sandbox)||void 0===e||e.stop(),t&&u.delete(this.name)}}var p;!function(t){t.NAME="name",t.URL="url"}(p||(p={}));class f extends HTMLElement{constructor(){super(),this.appName="",this.appUrl=""}static get observedAttributes(){return["name","url"]}connectedCallback(){console.log("picocontainer-app is connected");const t=new h({name:this.appName,url:this.appUrl,container:this});u.set(this.appName,t)}disconnectedCallback(){console.log("picocontainer-app has disconnected");u.get(this.appName).unmount(this.hasAttribute("destory"))}attributeChangedCallback(t,e,n){console.log(`attribute ${t}: ${n}-${e}`),this[t===p.NAME?"appName":"appUrl"]!==n&&(t!==p.URL||this.appUrl?t!==p.NAME||this.appName||(this.appName=n):this.appUrl=n)}}const m={start(){window.customElements.get("picocontainer-app")||window.customElements.define("picocontainer-app",f)}};exports.default=m;
//# sourceMappingURL=index.min.js.map
